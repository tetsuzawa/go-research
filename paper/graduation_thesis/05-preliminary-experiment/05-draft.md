# 雑音低減の予備実験

## ドローンの駆動音のサンプル収音

### 実験目的

@で述べたように、本研究で用いるアルゴリズムは参照信号が有色性を持つと収束性能が低下する特徴を持つ。したがって、リアルタイム処理が目的の場合、参照信号の周波数特性が処理効果に影響を及ぼすことになる。したがって、ドローンの駆動音の周波数特性を調べるため、サンプル収音を行った。

### 実験方法

#### 収音のためのハードウェア構成について

収音はドローンとバイノーラルマイクを使用し、@のブロック図の構成で行った。

ただし、前述のバイノーラルマイクのみでは十分な入力電圧が得られないため、収音にはマイクロフォンアンプを使用する必要がある。本実験では株式会社オーディオテクニカのマイクロフォンアンプAT-MA2を使用した。

なお、本研究では室内でサンプル収音を行ったため、据え置き型のマイクロフォンアンプを使用したが、実際にドローンに搭載する際は別途小型のマイクロフォンアンプが必要と推察される。

![pre-ex_block](figures/pre-ex_block.png)
![pre-ex_block](figures/pre-ex_block.pdf)

#### 収音に使用するソフトウェアについて

音声の収録にはGo言語で記述した自作の収音用コマンドラインツールを使用した。
@。
このプログラムは[SoX](http://sox.sourceforge.net/)(コマンドラインベースの音声編集ソフトウェア)の`rec`コマンドを参考に設計した。
オーディオ入出力APIの[PortAudio](http://www.portaudio.com/)を利用しており、多チャンネルでの収音に対応している他、独自の機能として音声データを本研究で主に使用されている形式（.DSB - 符号付き整数型16bitバイナリファイル) で保存することが可能となっている。

本実験では自作のソフトウェアを使用したが、.wavなどの一般的な音声データ形式を使用する場合、前述のSoXを利用しても同様に収音が可能である。また、同じくPortAudioをベースとしたGUIの音声編集ソフトウェアである[Audacity](https://www.audacityteam.org/)も有力な候補となる。いずれのソフトウェアも無料で使用可能である。


@TODO 使い方


使用機器を以下に示す

- 使用機器
   1. ドローン    
      @を参照。

   2. マイク
      @のバイノーラルマイクを1chのみ使用した。詳細は@を参照。

   3. マイクロフォンアンプ
      AT-MA2 株式会社オーディオテクニカ [at-ma2](https://www.audio-technica.co.jp/product/AT-MA2)
      ![at-ma2](figures/at-ma2.jpg)
      S/N. @TODO

   4. オーディオインターフェース 
      ローランド株式会社 DUO-CAPTURE EX S/N. @TODO
      [duo-capture](https://www.roland.com/jp/products/duo-capture_ex/)

### 実験結果

収録したドローンの駆動音の波形を@のプログラムを使用し、描画した図を@に示す。また、@のプログラムを使用し、周波数特性を解析した。駆動音のスペクトログラムを@に示す。

![drone_raw](figures/drone_raw.png)
![drone_raw_spectrogram](figures/drone_raw_spectrogram.png)

@、@における最初および最後の区間はドローンを停止させた無音区間となっている。しかしながら、無音区間に定常な雑音が存在することが明らかなため純粋なドローンの駆動音を解析するためには、この定常雑音を取り除く必要がある。

そこで、@のプログラムを使用し、スペクトラルサブトラクション法@により、無音区間の周波数成分の平均を全体から取り除いた。
スペクトラルサブトラクション法適用後の波形を@に、スペクトログラムを@に示す。

![drone_subtracted](figures/drone_subtracted.png)
![drone_subtracted_spectrogram](figures/drone_subtracted_spectrogram.png)

### 考察

@より、駆動音は100Hz付近の低域成分とその倍音成分、5kHz付近の中域成分、18kHz付近の高域成分を合わせた周波数特性を示すことがわかる。このうち、低域と中域の成分はドローンの羽音およびモータの回転音によるものであると思われる。また、高域成分はブラシレスモータの回転数を制御するインバータ回路によるものと思われる。

以上、ドローンの駆動音を有色性の周波数特性を持つことが確認できた。


## 信号の有色性に対するADFの性能への影響

### 実験目的

本節ではADFに対する参照信号を@で収音したドローンの駆動音とした場合と白色雑音とした場合の収束に要するサンプル数（収束速度）、収束した後の精度（推定精度）を比較する。
これにより、各適応アルゴリズムの信号の有色性に対する収束性能への影響を評価することを目的とする。

### 実験方法

実験方法を以下に示す。

1. @で収音した雑音処理完了後の音声（以下、駆動音とする）に対して、ADFの各アルゴリズムにおける最適なステップサイズを求める。
2. 1で求めたADFに対して、駆動音を参照信号、駆動音に白色雑音を加えたものを目的信号として十分な時間フィルタリングを実行
3. 同様に、白色雑音を参照信号、白色雑音にの別の白色雑音を加えたものを目的信号として十分な時間フィルタリングを実行
4. フィルタ誤差をMSEで平滑化したものをグラフ化し、各アルゴリズムで比較・評価

ただし、本実験におけるADFのフィルタ長は4サンプル、付与雑音は参照信号に対して-30dBの振幅、MSEのタップ数は512サンプルとした。

### 実験結果

信号に駆動音を使用した場合の各アルゴリズムの収束特性を@に示す。同様に、白色雑音を使用した場合の各アルゴリズムの収束特性を@に示す。

![drone_convergence](figures/algo_dr_L-4_mse.png)
![drone_convergence](figures/algo_white_L-4_mse.png)

### 考察

@@より、信号に駆動音を使用した場合、理論通り収束性能が低下していることがわかる。特にRLSアルゴリズムの場合、収束時のMSEが約80dBから約50dBとなり、収束するまでに必要なサンプル数も約300,000サンプル程度まで増加していることがわかる。サンプリング周波数は48kHzであるので収束までに約6秒かかることになる。一方、NLMSアルゴリズムとAPアルゴリズムは収束時のMSEは10dBほど悪化しているが、RLSアルゴリズムほど大きい性能低下は見られなかった。

以上より、リアルタイム処理を目的とする場合NLMS・APアルゴリズムの使用が適していると思われる。

## ADFライブラリのベンチマーク

### 実験目的

ADFの性能を評価する尺度の1つとして、収束速度、推定精度の他に演算時間（演算量）が存在する。
特にリアルタイムでフィルタ処理を行う場合、プログラムの実行速度は雑音低減の性能に大きな影響を及ぼす。

本節では、Go言語で自作したADFライブラリのベンチマークを行い、各アルゴリズムの実行に要する演算時間を評価することを目的とする。

### 実験方法

本実験ではGo言語に標準で実装されているベンチマークの仕組みを利用して行った。

Go言語ではテストファイルに`func BenchmarkXxx(b *testing.B)`のように関数を宣言することで容易にベンチマークを実装することができる。また、`for i := 0; i < b.N; i++`のようにfor文を記述することで、自動的に1秒あたりの実行回数を測定・出力することが可能である。なお、ベンチマークはテストファイルと同じディレクトリで`go test -bench . -benchmem`を実行することで行える。

ベンチマークのプログラムを@に示す。
@TODO

ベンチマークはそれぞれ信号として白色雑音を使用し、フィルタ長は8タップとした。

実行環境はRaspberry Pi 3 Model Bである。また、比較対象としてMacBook Pro (13-inch, 2019)上でもベンチマークを実行した。

### 実験結果

1サンプルあたりのフィルタ係数更新・次サンプルの予測にかかる演算時間とメモリ使用量の測定結果を@に示す。

@TODO rpi
| アルゴリズム | 演算時間[ms/op] | メモリ使用量[B/op] |
|:------------:|:---------------:|:------------------:|
|     NLMS     |       1.9       |         84         |
|      AP      |       78.4      |         941        |
|      RLS     |       52.9      |        2549        |

@TODO macbook pro
| アルゴリズム | 演算時間[ms/op] | メモリ使用量[B/op] |
|:------------:|:---------------:|:------------------:|
|     NLMS     |       0.13      |         96         |
|      AP      |       5.40      |        1248        |
|      RLS     |       3.25      |        2920        |


### 考察

#### メモリ使用量について

@より、各アルゴリズムのメモリ使用量はNLMSアルゴリズムが一番少なく、APアルゴリズム、RLSアルゴリズムと多くなっている。これは理論式に即した物となっており、妥当な値である。

Go言語にはガーベッジコレクションが実装されており、メモリセーフである。また、Raspberry Pi 3 Model Bのメモリは1GBと潤沢であるため、使用メモリに関しては実用範囲内であると思われる。

#### 演算時間について

@より、NLMSアルゴリズムの演算時間はAP・RLSに比べて数十倍高速であることがわかる。一方、Raspberry Piの演算時間はMacBook Proに比べるて十倍程度長いことがわかる。

ここで、これらのアルゴリズムをアクティブノイズコントロールに適用することを考える。参照信号用のマイクと目的信号用のマイクの距離が30cmであることを仮定すると、音波が2つのマイク間を移動するためにかかる時間は約0.88msである（音速は340m/sとした)。したがって、ADFのフィルタ実行時間以外を無視した理想条件で最低でも0.88ms/op以上の演算速度が必要なことになる。したがって、Raspberry Piを計算媒体としたアクティブノイズコントロールの実装は、制作したライブラリを使用する場合には現実的でないことが結論づけられる。
一方、自動等化器の実装には空間的制約が無いため、

また、APアルゴリズムの演算時間がRLSアルゴリズムに比べて長いことが表よりわかる。理論上の演算量はRLSアルゴリズムが上回っているため、アルゴリズムの実装を見直す必要があると考えられる。これについては今後の課題としたい。












